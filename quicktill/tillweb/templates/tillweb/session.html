{% extends "tillweb/tillweb.html" %}
{% load url from future %}

{% block title %}{{till}} — Session {{session.id}}{% endblock %}

{% block heading %}{{till}} — Session {{session.id}} ({{session.date}}){% endblock %}

{% block tillcontent %}

{% if session.endtime %}
<p>{{session.starttime}}–{{session.endtime}}</p>
{% else %}
<p>Started {{session.starttime}}</p>
{% endif %}

{% if session.endtime %}
{% if session.actual_totals %}
<table>
<tr>
{% for p in session.actual_totals %}
<td><strong>{{p.paytype.description}}</strong><br /><span class="money">{{p.amount}}</span></td>
{% endfor %}
<td><strong>Error</strong><br /><span class="money">{{session.error}}</span></td>
{% for vb,t,ex,vat in session.vatband_totals %}
{% if vb.business.show_vat_breakdown %}
<td><strong>{{vb.business}} ex-VAT</strong><br /><span class="money">{{ex}}</span></td>
<td><strong>{{vb.business}} VAT</strong><br /><span class="money">{{vat}}</span></td>
{% else %}
<td><strong>{{vb.business}}</strong><br /><span class="money">{{t}}</span></td>
{% endif %}
{% endfor %}
</tr>
</table>
{% else %}
<p>Session totals have not yet been recorded.</p>
{% endif %}
{% endif %}

<h2>Takings by department</h2>
{% if not session.endtime %}
<p>This session is still open, so may include transactions that have
not been closed.  These are shown in a separate column.</p>
{% endif %}

<table id="depttakings">
<thead>
<tr><th>Dept</th><th>Description</th>
{% if not session.endtime %}
<th>Paid</th>
<th>Pending</th>
{% endif %}
<th>Total</th>
</tr>
</thead>
<tbody>
{% for d,t,c,p in session.dept_totals_closed %}
{% if t or c %}
<tr class="{% cycle 'odd' 'even' %}">
<td>{{d.id}}</td>
<td><a href="{% url "sessiondept" pubname session.id d.id %}">{{d.description}}</a></td>
{% if not session.endtime %}
{% if c %}<td class="money">{{c}}</td>{% else %}<td></td>{% endif %}
<td class="money">{{p}}</td>
{% endif %}
<td class="money">{{t}}</td>
</tr>
{% endif %}
{% endfor %}
</tbody>
<tfoot>
<tr><td></td><td>Total</td>
{% if not session.endtime %}
<td class="money">{{session.closed_total}}</td>
<td class="money">{{session.pending_total}}</td>
{% endif %}
<td class="money">{{session.total}}</td>
</tr>
</tfoot>
</table>

<script type="text/javascript">
$(document).ready(function(){
  $("#depttakings").tablesorter({widgets:["zebra"]});
});
</script>

{% if not session.endtime %}
<h2>Takings by payment type</h2>
<p>Takings recorded so far this session.  May include part-paid
transactions.</p>
<table>
<tr><th>Type</th><th>Amount</th></tr>
{% for type,amount in session.payment_totals %}
<tr><td>{{type}}</td><td class="money">{{amount}}</td></tr>
{% endfor %}
</table>
{% endif %}

{% with usertotals=session.user_totals %}
{% if usertotals %}
<h2>Takings by user</h2>

<table id="usertakings">
<thead>
<tr><th>User</th><th>Items</th><th>Total</th></tr>
</thead>
<tbody>
{% for user,i,t in usertotals %}
<tr class="{% cycle 'odd' 'even' %}">
<td><a href="{{u}}{{user.tillweb_url}}">{{user.fullname}}</a></td>
<td>{{i}}</td>
<td class="money">{{t}}</td>
</tr>
{% empty %}
<tr><td>Not recorded</td><td></td></tr>
{% endfor %}
</tbody>
</table>

<script type="text/javascript">
$(document).ready(function(){
  $("#usertakings").tablesorter({widgets:["zebra"]});
});
</script>
{% endif %}
{% endwith %}

<h2>Stock sold in this session</h2>
<table id="stocksold">
<thead>
<tr><th>Type</th><th>Quantity</th></tr>
</thead>
<tbody>
{% for st,q in session.stock_sold %}
<tr><td><a href="{{u}}{{st.tillweb_url}}">{{st.shortname}}</a></td>
<td>{{q}} {{st.unit.name}}s</td></tr>
{% empty %}
<tr><td>None</td></tr>
{% endfor %}
</tbody>
</table>

<script type="text/javascript">
$(document).ready(function(){
  $("#stocksold").tablesorter({widgets:["zebra"]});
});
</script>

<h2>Transactions</h2>

<table id="transactions">
<thead>
<tr><th>Transaction</th><th>Amount</th><th>Note</th><th>State</th></tr>
</thead>
<tbody>
{% for t in session.transactions %}
<tr class="{% cycle 'odd' 'even' %}">
<td><a href="{{u}}{{t.tillweb_url}}">{{t.id}}</a></td>
<td class="money">{{t.total}}</td>
<td>{% if t.notes %}{{t.notes}}{% endif %}</td>
<td>{% if t.closed %}Paid:
{% for pt,amount in t.payments_summary %}
{{pt}} (<span class="money">{{amount}}</span>)
{% endfor %}{% else %}Open{% endif %}</td>
</tr>
{% endfor %}
</tbody>
</table>

<script type="text/javascript">
$(document).ready(function(){
  $("#transactions").tablesorter({widgets:["zebra"]});
});
</script>


{% endblock %}
